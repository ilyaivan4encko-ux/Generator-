
<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –®–∏—à–∫–∞ ‚Äî –ü–æ–¥–¥–µ—Ä–∂–∏ —Å–∞–π—Ç ‚ö°</title>
<meta name="theme-color" content="#0b0f14">
<style>
  :root{
    --bg:#0b0f14;
    --panel:#0f1720;
    --muted:#9aa4b2;
    --accent:#ffd27a;
    --accent-2:#ff7f50;
    --good:#7be57b;
    --danger:#ff6b6b;
    --glass: rgba(255,255,255,0.02);
    --radius:14px;
    --shadow: 0 8px 30px rgba(3,6,12,0.7);
    font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  }
  *{box-sizing:border-box;margin:0;padding:0}
  html,body{height:100%}
  body{
    background: linear-gradient(180deg,#07090c,var(--bg));
    color:#e8eef6;
    -webkit-font-smoothing:antialiased;
    padding:12px;
  }

  /* Mobile-first container */
  .app{
    max-width:760px;margin:0 auto;display:flex;flex-direction:column;gap:12px;
  }
  header{display:flex;align-items:center;justify-content:space-between;gap:8px}
  .brand{display:flex;gap:10px;align-items:center}
  .logo{width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;font-weight:900;color:#141414;font-size:24px;box-shadow:var(--shadow)}
  h1{font-size:16px;margin-bottom:4px}
  .lead{font-size:12px;color:var(--muted)}

  .panel{
    background:linear-gradient(180deg, rgba(255,255,255,0.012), rgba(255,255,255,0.01));
    border-radius:var(--radius);padding:14px;border:1px solid rgba(255,255,255,0.03);box-shadow:var(--shadow);
  }

  .status{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .stat{background:var(--glass);padding:8px 10px;border-radius:10px;font-weight:700;font-size:14px}
  .stat small{display:block;font-weight:400;font-size:11px;color:var(--muted)}

  .generator{
    display:flex;flex-direction:column;gap:10px;align-items:center;text-align:center;
  }
  .gen-visual{width:140px;height:140px;border-radius:20px;background:linear-gradient(180deg,#1a2430,#08121a);display:flex;align-items:center;justify-content:center;font-size:40px;box-shadow:0 14px 40px rgba(2,6,23,0.6)}
  .gen-power{font-size:22px;font-weight:900;margin-top:6px}
  .generator .small{font-size:12px;color:var(--muted)}

  .controls{display:flex;gap:8px;flex-wrap:wrap;justify-content:center}
  button.btn{background:linear-gradient(180deg,#1f8cff,#0060d6);border:none;padding:10px 12px;border-radius:10px;color:white;font-weight:800;cursor:pointer}
  button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted)}

  .game-row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .resource-list{display:flex;gap:8px;overflow:auto;padding:6px}
  .res-card{min-width:120px;background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);padding:10px;border-radius:12px;border:1px solid rgba(255,255,255,0.03);text-align:center}
  .res-card button{width:100%;margin-top:8px}

  .shop-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
  .shop-item{background:rgba(255,255,255,0.01);padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.02);font-size:13px}
  .shop-item .title{font-weight:800;margin-bottom:6px}
  .upgrade-level{font-size:12px;color:var(--muted);margin-top:6px}

  .footer{display:flex;gap:8px;justify-content:space-between;align-items:center;font-size:12px;color:var(--muted)}

  /* Modal */
  .modal{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(2,6,12,0.6);z-index:60;padding:20px}
  .modal .panel{max-width:520px;width:100%}

  /* Responsive tweaks */
  @media(min-width:800px){
    .app{padding:24px}
    .gen-visual{width:200px;height:200px;font-size:56px;border-radius:20px}
  }
</style>
</head>
<body>
<div class="app">

  <header>
    <div class="brand">
      <div class="logo">–®</div>
      <div>
        <h1>–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –®–∏—à–∫–∞</h1>
        <div class="lead">–õ–æ—Ä: —ç—Ç–æ—Ç –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä –ø–∏—Ç–∞–µ—Ç —Å–∞–π—Ç —ç–ª–µ–∫—Ç—Ä–∏—á–µ—Å—Ç–≤–æ–º ‚Äî –ø–æ–¥–¥–µ—Ä–∂–∏ –µ–≥–æ —Ä–∞–±–æ—Ç—É!</div>
      </div>
    </div>
    <div style="text-align:right">
      <div class="muted" style="font-size:12px;color:var(--muted)">–£—Ä–æ–≤–µ–Ω—å</div>
      <div id="levelDisplay" style="font-weight:900">1</div>
    </div>
  </header>

  <section class="panel generator" id="generatorPanel" aria-live="polite">
    <div class="gen-visual" id="genVisual">üîå</div>
    <div class="gen-power" id="powerDisplay">–≠–Ω–µ—Ä–≥–∏—è: 0%</div>
    <div class="small" id="genLore">–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –Ω–∞ –º—É—Å–æ—Ä–Ω–æ–π —Å–≤–∞–ª–∫–µ. –°–æ–±–∏—Ä–∞—Ç—å –≥–æ—Ä—è—â–∏–µ —Ä–µ—Å—É—Ä—Å—ã, —á—Ç–æ–±—ã –≤—ã—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å —ç–Ω–µ—Ä–≥–∏—é –¥–ª—è —Å–∞–π—Ç–∞.</div>

    <div class="game-row">
      <div class="status">
        <div class="stat">–ë–∞–ª–∞–Ω—Å: <span id="coins">0</span> <small>—à–∏—à–∫–∞-–∫–æ–∏–Ω–æ–≤</small></div>
        <div class="stat">–¢–æ–ø–ª–∏–≤–æ: <span id="fuel">0</span> <small>–µ–¥.</small></div>
        <div class="stat">–ù–∞–≥—Ä—É–∑–∫–∞: <span id="load">0</span>% <small>—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å</small></div>
      </div>
    </div>

    <div class="controls" style="margin-top:6px">
      <button class="btn" id="collectBtn">–ö–ª–∏–∫ ‚Äî –ø–æ–∏—Å–∫ –≥–æ—Ä—è—â–µ–≥–æ –º—É—Å–æ—Ä–∞</button>
      <button class="btn ghost" id="autoBtn">–ö—É–ø–∏—Ç—å –∞–≤—Ç–æ—Å–±–æ—Ä (–ª–æ–≥–∏—Å—Ç–∏–∫–∞)</button>
      <button class="ghost" id="shopBtn">–ú–∞–≥–∞–∑–∏–Ω</button>
      <button class="ghost" id="saveBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
  </section>

  <section class="panel">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <div style="font-weight:900">–†–µ—Å—É—Ä—Å—ã</div>
      <div class="muted" id="resourceHint">–ú—É—Å–æ—Ä–Ω–∞—è —Å–≤–∞–ª–∫–∞: —à–∞–Ω—Å 20% –Ω–∞–π—Ç–∏ –≥–æ—Ä—è—â–∏–π –º—É—Å–æ—Ä –∑–∞ –∫–ª–∏–∫</div>
    </div>
    <div class="resource-list" id="resourceList">
      <!-- resource cards appended here -->
    </div>
  </section>

  <section class="panel">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <div style="font-weight:900">–ú–∞–≥–∞–∑–∏–Ω ‚Äî —É–ª—É—á—à–µ–Ω–∏—è</div>
      <div class="muted">–ü—è—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏–π –ø–æ 5 —É—Ä–æ–≤–Ω–µ–π</div>
    </div>
    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px">
      <button class="btn ghost" data-shop="generator">–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä</button>
      <button class="btn ghost" data-shop="wiring">–ü—Ä–æ–≤–æ–¥–∫–∞</button>
      <button class="btn ghost" data-shop="logistics">–õ–æ–≥–∏—Å—Ç–∏–∫–∞</button>
      <button class="btn ghost" data-shop="fuel">–ö–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ç —Ç–æ–ø–ª–∏–≤–∞</button>
      <button class="btn ghost" data-shop="misc">–†–∞–∑–Ω–æ–µ</button>
    </div>

    <div id="shopGrid" class="shop-grid">
      <!-- items injected here -->
    </div>
  </section>

  <div class="footer">
    <div class="muted">–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞: –ª–æ–∫–∞–ª—å–Ω–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ</div>
    <div style="display:flex;gap:8px">
      <button class="ghost" id="resetBtn">–°–±—Ä–æ—Å–∏—Ç—å</button>
      <button class="ghost" id="exportBtn">–≠–∫—Å–ø–æ—Ä—Ç</button>
    </div>
  </div>

</div>

<!-- Modal -->
<div id="modal" class="modal" style="display:none" role="dialog" aria-modal="true">
  <div class="panel">
    <div id="modalContent"></div>
    <div style="display:flex;justify-content:flex-end;margin-top:12px;gap:8px">
      <button class="ghost" id="modalClose">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
  </div>
</div>

<script>
/* ====== Mobile-first generator game
   - 5 world levels:
     1: –º—É—Å–æ—Ä–∫–∞ (20% —à–∞–Ω—Å –≥–æ—Ä—è—â–µ–≥–æ –º—É—Å–æ—Ä–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ)
     2: –ª–µ—Å (5 –∫–ª–∏–∫–æ–≤ -> –±—Ä–µ–≤–Ω–æ)
     3: —à–∞—Ö—Ç–∞ (10 –∫–ª–∏–∫–æ–≤ -> —É–≥–æ–ª—å)
     4: –Ω–µ—Ñ—Ç–µ–ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∞ (–Ω—É–∂–µ–Ω —É–≥–æ–ª—å –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –±–µ–Ω–∑–∏–Ω–∞)
     5: —Ñ–∏–Ω–∞–ª: "–æ–π –æ–±–º–∞–Ω—É–ª" ‚Äî –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä –ª–æ–º–∞–µ—Ç—Å—è
   - 5 upgrade categories: generator, wiring, logistics, fuel, misc
   - each category has 5 levels, buyable in shop
   - progress saved to localStorage
*/

const STORAGE = 'shishka_generator_v1';
let state = {
  level:1,
  energy:0,        // percent 0-100
  fuel:0,          // generic fuel units
  coins:200,
  load:0,
  upgrades: {
    generator:0, wiring:0, logistics:0, fuel:0, misc:0
  },
  resources: { trash:0, wood:0, coal:0, oil:0, fuelGas:0 },
  clicks: { wood:0, coal:0 },
  autos: { logistics:false },
  history: []
};

function load(){ try{ const raw = localStorage.getItem(STORAGE); if(raw) state = JSON.parse(raw); }catch(e){ console.warn(e); } }
function save(){ localStorage.setItem(STORAGE, JSON.stringify(state)); updateUI(); }

load();

/* ===== Game constants and definitions ===== */
const TRASH_ITEMS = ['—Å—Ç–æ–ø–∫–∞ —Å—Ç–∞—Ä—ã—Ö –∫–Ω–∏–≥','—Å—Ç–∞—Ä–∞—è –æ–¥–µ–∂–¥–∞','–∫–∞—Ä—Ç–æ–Ω–Ω–∞—è –∫–æ—Ä–æ–±–∫–∞','—Å–≥–æ—Ä–µ–≤—à–∏–π –º–∞—Ç—Ä–∞—Å','–≤—ã—Å–æ—Ö—à–∞—è –≥–∞–∑–µ—Ç–∞'];
const SHOP = {
  generator: [
    {title:'–ü–æ—Ä—à–µ–Ω—å Mk.I', desc:'+5% —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏', cost:100},
    {title:'–ö–æ—Ç—ë–ª —É—Å–∏–ª–µ–Ω–Ω—ã–π', desc:'+10% —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏', cost:250},
    {title:'–¢—É—Ä–±–∏–Ω–∞', desc:'+15% —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏', cost:500},
    {title:'–ò–Ω–∂–µ–∫—Ç–æ—Ä', desc:'+25% —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏', cost:1200},
    {title:'–ö–≤–∞–Ω—Ç–æ–≤—ã–π –º–æ–¥—É–ª—å', desc:'+50% —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏', cost:4000},
  ],
  wiring: [
    {title:'–ò–∑–æ–ª—è—Ü–∏—è Bronze', desc:'-2% –ø–æ—Ç–µ—Ä—å', cost:80},
    {title:'–ü—Ä–æ–≤–æ–¥ –º–µ–¥–Ω—ã–π', desc:'-4% –ø–æ—Ç–µ—Ä—å', cost:220},
    {title:'–®—É–Ω—Ç', desc:'-7% –ø–æ—Ç–µ—Ä—å', cost:480},
    {title:'–û–ø—Ç–æ–≤–æ–ª–æ–∫–Ω–æ', desc:'-12% –ø–æ—Ç–µ—Ä—å', cost:1100},
    {title:'–°—É–ø–µ—Ä–ø—Ä–æ–≤–æ–¥–Ω–∏–∫', desc:'-25% –ø–æ—Ç–µ—Ä—å', cost:3500},
  ],
  logistics: [
    {title:'–¢–µ–ª–µ–∂–∫–∞', desc:'+–∞–≤—Ç–æ—Å–±–æ—Ä –º—É—Å–æ—Ä–∞ (–º–µ–¥–ª.)', cost:120},
    {title:'–ú–æ—Ç–æ–ø–∏–ª–∞', desc:'+—Å–∫–æ—Ä–æ—Å—Ç—å —Ä—É–±–∫–∏', cost:300},
    {title:'–≠–∫—Å–∫–∞–≤–∞—Ç–æ—Ä', desc:'+—Å–∫–æ—Ä–æ—Å—Ç—å —à–∞—Ö—Ç—ã', cost:700},
    {title:'–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω–∞—è —Å–µ—Ç—å', desc:'+—Å–∫–æ—Ä–æ—Å—Ç—å –¥–æ—Å—Ç–∞–≤–∫–∏', cost:1500},
    {title:'–†–æ–±–æ—Ç‚Äë–∫—É—Ä—å–µ—Ä', desc:'–ø–æ–ª–Ω–æ—Å—Ç—å—é –∞–≤—Ç–æ—Å–±–æ—Ä', cost:4200},
  ],
  fuel: [
    {title:'–ü—Ä–∏–º–µ—Å—å A', desc:'+5% —Ü–µ–Ω–Ω–æ—Å—Ç–∏ —Ç–æ–ø–ª–∏–≤–∞', cost:90},
    {title:'–ö–∞—Ç–∞–ª–∏–∑–∞—Ç–æ—Ä', desc:'+10% —Ü–µ–Ω–Ω–æ—Å—Ç–∏', cost:240},
    {title:'–°—É–ø–µ—Ä–∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ç', desc:'+20% —Ü–µ–Ω–Ω–æ—Å—Ç–∏', cost:600},
    {title:'–°–∂–∞—Ç–æ‚Äë–ø–æ—Ä–æ—à–æ–∫', desc:'+35% —Ü–µ–Ω–Ω–æ—Å—Ç–∏', cost:1400},
    {title:'–§–æ—Ä–º–∞ —ç–Ω–µ—Ä–¥–∂–∏', desc:'+70% —Ü–µ–Ω–Ω–æ—Å—Ç–∏', cost:3800},
  ],
  misc: [
    {title:'–Ø—â–∏–∫ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤', desc:'+–º–∞–ª–µ–Ω—å–∫–∏–π –±–æ–Ω—É—Å –∫ –∫–ª–∏–∫–∞–º', cost:50},
    {title:'–ö–∞—Ä—Ç–∞ –º–µ—Å—Ç–Ω–æ—Å—Ç–∏', desc:'+—à–∞–Ω—Å –Ω–∞–π—Ç–∏ —Ä–µ–¥–∫–∏–π –º—É—Å–æ—Ä', cost:140},
    {title:'–§–æ–Ω–∞—Ä—å', desc:'+–Ω–æ—á–Ω–∞—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å', cost:320},
    {title:'–ö–æ—Ç –≤ –∫–æ—Ä–æ–±–∫–µ', desc:'–ø–æ–≤—ã—à–∞–µ—Ç –º–æ—Ä–∞–ª—å (–≤–∫—É—Å–Ω–æ)', cost:900},
    {title:'–¢–æ—Ç–µ–º —É–¥–∞—á–∏', desc:'+—à–∞–Ω—Å –¥—Ä–æ–ø–∞ —Ä–µ—Å—É—Ä—Å–æ–≤', cost:2600},
  ]
};

/* ===== Helpers ===== */
const $ = id => document.getElementById(id);
function format(n){ return Math.floor(n); }
function rand(n){ return Math.random()*n; }
function chance(p){ return Math.random() < p; }

/* ===== UI building ===== */
function renderResources(){
  const list = $('resourceList'); list.innerHTML='';
  // Trash card
  const t = document.createElement('div'); t.className='res-card';
  t.innerHTML = `<div style="font-weight:900">–ú—É—Å–æ—Ä</div><div class="muted" style="font-size:12px">–ì–æ—Ä—é—á–∏–µ –Ω–∞—Ö–æ–¥–∫–∏</div><div style="font-size:18px;font-weight:900;margin-top:6px" id="trashCount">${state.resources.trash}</div><button class="btn ghost" id="burnTrash">–°–∂–µ—á—å –º—É—Å–æ—Ä ‚Üí —Ç–æ–ø–ª–∏–≤–æ</button>`;
  list.appendChild(t);
  // Wood card (unlocked on level 2)
  const w = document.createElement('div'); w.className='res-card';
  w.innerHTML = `<div style="font-weight:900">–î–µ—Ä–µ–≤–æ</div><div class="muted" style="font-size:12px">5 –∫–ª–∏–∫–æ–≤ = 1 –±—Ä–µ–≤–Ω–æ</div><div style="font-size:18px;font-weight:900;margin-top:6px" id="woodCount">${state.resources.wood}</div><button class="btn ghost" id="chopWood">–†—É–±–∏—Ç—å –¥–µ—Ä–µ–≤–æ</button>`;
  list.appendChild(w);
  // Coal card (level 3)
  const c = document.createElement('div'); c.className='res-card';
  c.innerHTML = `<div style="font-weight:900">–£–≥–æ–ª—å</div><div class="muted" style="font-size:12px">10 –∫–ª–∏–∫–æ–≤ = 1 —É–≥–æ–ª—å</div><div style="font-size:18px;font-weight:900;margin-top:6px" id="coalCount">${state.resources.coal}</div><button class="btn ghost" id="mineCoal">–ö–æ–ø–∞—Ç—å</button>`;
  list.appendChild(c);
  // Oil card (level 4)
  const o = document.createElement('div'); o.className='res-card';
  o.innerHTML = `<div style="font-weight:900">–ù–µ—Ñ—Ç—å</div><div class="muted" style="font-size:12px">–ü–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∞ –≤ –±–µ–Ω–∑–∏–Ω —Ç—Ä–µ–±—É–µ—Ç —É–≥–ª—è</div><div style="font-size:18px;font-weight:900;margin-top:6px" id="oilCount">${state.resources.oil}</div><button class="btn ghost" id="pumpOil">–î–æ–±—ã—Ç—å –Ω–µ—Ñ—Ç—å</button>`;
  list.appendChild(o);
  // Fuel (gasoline)
  const f = document.createElement('div'); f.className='res-card';
  f.innerHTML = `<div style="font-weight:900">–ë–µ–Ω–∑–∏–Ω</div><div class="muted" style="font-size:12px">–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏</div><div style="font-size:18px;font-weight:900;margin-top:6px" id="fuelCount">${state.resources.fuelGas}</div><button class="btn ghost" id="refineBtn">–ü–µ—Ä–µ—Ä–∞–±–æ—Ç–∞—Ç—å ‚Üí –±–µ–Ω–∑–∏–Ω</button>`;
  list.appendChild(f);

  // attach buttons
  $('burnTrash').addEventListener('click', ()=>{
    if (state.resources.trash <=0){ toast('–ù–µ—Ç –º—É—Å–æ—Ä–∞'); return; }
    const efficiency = 1 + state.upgrades.fuel*0.05;
    const fuelGain = Math.max(1, Math.floor(state.resources.trash * 0.6 * efficiency));
    state.resources.trash = 0;
    state.resources.fuelGas += fuelGain;
    state.history.push({type:'burnTrash', fuelGain, time:Date.now()});
    toast(`–°–æ–∂–∂–µ–Ω–æ –º—É—Å–æ—Ä–∞ ‚Üí +${fuelGain} –µ–¥. —Ç–æ–ø–ª–∏–≤–∞`);
    updateUI(); save();
  });
  $('chopWood').addEventListener('click', ()=>{
    if (state.level < 2){ toast('–õ–µ—Å –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω'); return; }
    state.clicks.wood++;
    const need = Math.max(1, 5 - Math.floor(state.upgrades.logistics*0.6));
    if (state.clicks.wood >= need){
      state.resources.wood += 1 + Math.floor(state.upgrades.logistics*0.2);
      state.clicks.wood = 0;
      toast('–ü–æ–ª—É—á–µ–Ω–æ 1 –±—Ä–µ–≤–Ω–æ');
    } else {
      toast(`–†—É–±–∫–∞... (${state.clicks.wood}/${need})`);
    }
    updateUI(); save();
  });
  $('mineCoal').addEventListener('click', ()=>{
    if (state.level < 3){ toast('–®–∞—Ö—Ç–∞ –Ω–µ –¥–æ—Å—Ç—É–ø–Ω–∞'); return; }
    state.clicks.coal++;
    const need = Math.max(3, 10 - Math.floor(state.upgrades.logistics*1.2));
    if (state.clicks.coal >= need){
      state.resources.coal += 1 + Math.floor(state.upgrades.logistics*0.2);
      state.clicks.coal = 0;
      toast('–î–æ–±—ã—Ç —É–≥–æ–ª—å');
    } else {
      toast(`–ö–æ–ø–∞–µ–º... (${state.clicks.coal}/${need})`);
    }
    updateUI(); save();
  });
  $('pumpOil').addEventListener('click', ()=>{
    if (state.level < 4){ toast('–ù–µ—Ñ—Ç–µ–∫–æ–ª–æ–Ω–Ω–∞ –Ω–µ –¥–æ—Å—Ç—É–ø–Ω–∞'); return; }
    // oil requires some coal to pump? We'll allow pumping but with small randomness
    if (state.resources.coal <=0){ toast('–ù—É–∂–µ–Ω —É–≥–æ–ª—å –¥–ª—è –ø–∏—Ç–∞–Ω–∏—è –Ω–∞—Å–æ—Å–∞'); return; }
    state.resources.coal -= 1;
    const gained = 1 + Math.floor(state.upgrades.logistics*0.2);
    state.resources.oil += gained;
    toast(`–î–æ–±—ã—Ç–æ –Ω–µ—Ñ—Ç–∏ +${gained} (—É–∫—Ä–∞–¥–µ–Ω–æ 1 —É–≥–æ–ª—å –Ω–∞ –ø–∏—Ç–∞–Ω–∏–µ)`);
    updateUI(); save();
  });
  $('refineBtn').addEventListener('click', ()=>{
    if (state.resources.oil <=0){ toast('–ù–µ—Ç –Ω–µ—Ñ—Ç–∏'); return; }
    const needCoal = Math.max(1, 2 - Math.floor(state.upgrades.fuel*0.2));
    if (state.resources.coal < needCoal){ toast(`–î–ª—è –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∏ –Ω—É–∂–µ–Ω —É–≥–æ–ª—å x${needCoal}`); return; }
    state.resources.coal -= needCoal;
    const efficiency = 1 + state.upgrades.fuel*0.08 + state.upgrades.generator*0.02;
    const out = Math.max(1, Math.floor(state.resources.oil * 0.8 * efficiency));
    state.resources.oil = 0;
    state.resources.fuelGas += out;
    toast(`–ü–µ—Ä–µ—Ä–∞–±–æ—Ç–∞–Ω–æ –Ω–µ—Ñ—Ç–∏ ‚Üí –±–µ–Ω–∑–∏–Ω +${out}`);
    updateUI(); save();
  });
}

function renderShop(category='generator'){
  const grid = $('shopGrid'); grid.innerHTML='';
  const items = SHOP[category] || [];
  items.forEach((it, idx)=>{
    const lvl = state.upgrades[category] || 0;
    const unlocked = idx < lvl; // previous levels bought
    const purchasable = idx === lvl; // buy next
    const div = document.createElement('div'); div.className='shop-item';
    div.innerHTML = `<div class="title">${it.title}</div><div class="muted">${it.desc}</div><div class="upgrade-level">–£—Ä–æ–≤–µ–Ω—å: ${lvl}/5</div><div style="margin-top:8px"><strong>–¶–µ–Ω–∞: ${it.cost}</strong></div>`;
    const btn = document.createElement('button'); btn.className='btn ghost'; btn.style.marginTop='8px';
    if (purchasable){ btn.textContent='–ö—É–ø–∏—Ç—å'; btn.addEventListener('click', ()=> buyUpgrade(category, idx)); }
    else if (unlocked){ btn.textContent='–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ'; btn.disabled=true; }
    else { btn.textContent='–°–Ω–∞—á–∞–ª–∞ –ø—Ä–µ–¥—ã–¥—É—â–∏–π'; btn.disabled=true; }
    div.appendChild(btn);
    grid.appendChild(div);
  });
}

function buyUpgrade(cat, idx){
  const item = SHOP[cat][idx];
  if (state.coins < item.cost){ toast('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —à–∏—à–∫–∞-–∫–æ–∏–Ω–æ–≤'); return; }
  // purchase
  state.coins -= item.cost;
  state.upgrades[cat] = (state.upgrades[cat] || 0) + 1;
  state.history.push({type:'upgrade', cat, title:item.title, cost:item.cost, time:Date.now()});
  toast(`–ö—É–ø–ª–µ–Ω–æ: ${item.title}`);
  applyUpgradeEffects(cat);
  renderShop(cat);
  updateUI(); save();
}

/* ===== Game loop and mechanics ===== */
function collectClick(){
  // main click on trash level (level1)
  if (state.level === 5){
    // final twist: break
    showModal(`<h3>–û–π, –æ–±–º–∞–Ω—É–ª ‚Äî –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Å–ª–æ–º–∞–ª—Å—è ü§ñüí•</h3><p>–ù—É —Ç—ã –∏ –ø–æ–ø–∞–ª—Å—è ‚Äî –∏–≥—Ä–∞ –∑–∞–∫–æ–Ω—á–µ–Ω–∞. –°–ø–∞—Å–∏–±–æ –∑–∞ —Ç–µ—Å—Ç!</p>`);
    return;
  }
  // chance to find burning trash. base 20% plus bonuses
  const base = 0.20;
  const bonus = (state.upgrades.misc * 0.02) + (state.upgrades.logistics * 0.03);
  const chanceFind = Math.min(0.9, base + bonus);
  if (chance(chanceFind)){
    // find some trash piece
    const found = TRASH_ITEMS[Math.floor(Math.random()*TRASH_ITEMS.length)];
    const amount = 1 + Math.floor(state.upgrades.generator*0.1);
    state.resources.trash += amount;
    state.history.push({type:'find', item:found, amount, time:Date.now()});
    toast(`–ù–∞–π–¥–µ–Ω–æ: ${found} (+${amount} –º—É—Å–æ—Ä–∞)`);
  } else {
    toast('–ü—É—Å—Ç–æ...');
  }
  // progression: if enough fuel produced, increase energy and maybe level up
  produceEnergyFromFuel();
  // autos
  if (state.autos.logistics || state.upgrades.logistics >= 5){
    // small auto collection bonus
    const autoChance = 0.15 + state.upgrades.logistics*0.03;
    if (chance(autoChance)){
      state.resources.trash += 1 + Math.floor(state.upgrades.logistics*0.1);
      toast('–õ–æ–≥–∏—Å—Ç–∏–∫–∞ –ø—Ä–∏–≤–µ–∑–ª–∞ –Ω–µ–º–Ω–æ–≥–æ –º—É—Å–æ—Ä–∞');
    }
  }
  updateUI(); save();
}

function produceEnergyFromFuel(){
  // consume fuelGas slowly to produce 'energy'
  const baseProduce = 2 + state.upgrades.generator*1.5; // per tick on click
  const consume = Math.max(0, Math.floor(baseProduce * 0.4));
  if (state.resources.fuelGas >= consume && consume>0){
    state.resources.fuelGas -= consume;
    const gain = baseProduce * (1 + state.upgrades.fuel*0.06);
    state.energy = Math.min(100, state.energy + gain*0.8);
    state.load = Math.min(100, state.load + Math.floor(state.upgrades.wiring* -1 + 1));
  } else if (state.resources.trash > 0){
    // fallback: burn trash on the fly
    state.resources.trash = Math.max(0, state.resources.trash-1);
    state.energy = Math.min(100, state.energy + 6);
  } else {
    // nothing to burn: energy decays
    state.energy = Math.max(0, state.energy - 2 - state.upgrades.wiring*0.4);
  }
  // level up conditions
  if (state.energy >= 100){
    // progress to next level if not max
    if (state.level < 5){
      state.level++;
      state.energy = 30; // reset a bit
      toast(`–£—Ä–æ–≤–µ–Ω—å –¥–æ—Å—Ç–∏–≥–Ω—É—Ç! –û—Ç–∫—Ä—ã–ª—Å—è –Ω–æ–≤—ã–π —Ä–µ–≥–∏–æ–Ω: ${regionName(state.level)}`);
      // reveal new region text
      $('genLore').textContent = loreForLevel(state.level);
      // if reached level 5 -> final
      if (state.level === 5){
        showModal(`<h3>–û–π, –æ–±–º–∞–Ω—É–ª ‚Äî –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Å–ª–æ–º–∞–ª—Å—è ü§ñüí•</h3><p>–ü–æ—Ö–æ–∂–µ, –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä –≤—ã—à–µ–ª –∏–∑ —Å—Ç—Ä–æ—è –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –Ω–∞ –ø—è—Ç—ã–π —É—Ä–æ–≤–µ–Ω—å...</p>`);
      }
    } else {
      // at max level, cap
      state.energy = 100;
    }
  }
}

function regionName(lvl){
  return ['–ú—É—Å–æ—Ä–∫–∞','–õ–µ—Å','–®–∞—Ö—Ç–∞','–ù–µ—Ñ—Ç–µ–ø—Ä–æ–º—ã—Å–µ–ª','–§–∏–Ω–∞–ª'][lvl-1] || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
}
function loreForLevel(lvl){
  return {
    1: '–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Å—Ç–æ–∏—Ç –Ω–∞ —Å–≤–∞–ª–∫–µ ‚Äî –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Å–∞–π—Ç, –∏—Å–ø–æ–ª—å–∑—É—è –Ω–∞–π–¥–µ–Ω–Ω—ã–π –≥–æ—Ä—è—â–∏–π –º—É—Å–æ—Ä. –°–æ–±–∏—Ä–∞–π –∏ —Å–∂–∏–≥–∞–π.',
    2: '–¢—ã –¥–æ–±—Ä–∞–ª—Å—è –¥–æ –ª–µ—Å–∞ ‚Äî —Ç–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –¥–æ–±—ã–≤–∞—Ç—å –¥–µ—Ä–µ–≤–æ. –ë–µ—Ä–µ–≥–∏ –ª–µ—Å, –Ω–æ –≤—ã–∂–∏–≤–∞–Ω–∏–µ —Å–∞–π—Ç–∞ –≤–∞–∂–Ω–µ–µ.',
    3: '–®–∞—Ö—Ç—ë—Ä—Å–∫–∏–µ —Ç–æ–Ω–Ω–µ–ª–∏ –æ—Ç–∫—Ä—ã—Ç—ã ‚Äî –∫–æ–ø–∞–π —É–≥–æ–ª—å, –æ–Ω –º–æ—â–Ω–µ–µ –º—É—Å–æ—Ä–∞ –∏ –¥–µ—Ä–µ–≤–∞.',
    4: '–ù–µ—Ñ—Ç–µ–∫–æ–ª–æ–Ω–Ω–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞ ‚Äî –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∞–π –Ω–µ—Ñ—Ç—å –≤ –±–µ–Ω–∑–∏–Ω, –Ω–æ —É—á—Ç–∏: –¥–ª—è –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∏ –Ω—É–∂–µ–Ω —É–≥–æ–ª—å.',
    5: '...–∫–∞–∂–µ—Ç—Å—è —ç—Ç–æ –Ω–µ –∫–æ–Ω–µ—Ü. –û–π, –æ–±–º–∞–Ω—É–ª ‚Äî –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Å–ª–æ–º–∞–ª—Å—è!'
  }[lvl] || '';
}

/* ===== Shop UI wiring ===== */
document.querySelectorAll('[data-shop]').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    const cat = btn.dataset.shop;
    renderShop(cat);
  });
});
$('shopBtn').addEventListener('click', ()=>{ renderShop('generator'); showModal($('.panel').length); });

// top buttons
$('collectBtn').addEventListener('click', collectClick);
$('autoBtn').addEventListener('click', ()=>{
  // buy simple autos: cost scales
  const cost = 400 + state.upgrades.logistics*200;
  if (state.coins < cost){ toast('–ù—É–∂–Ω—ã —à–∏—à–∫–∞-–∫–æ–∏–Ω—ã: ' + cost); return; }
  state.coins -= cost;
  state.autos.logistics = true;
  toast('–ö—É–ø–ª–µ–Ω –∞–≤—Ç–æ—Å–±–æ—Ä –ª–æ–≥–∏—Å—Ç–∏–∫–∏');
  updateUI(); save();
});
$('saveBtn').addEventListener('click', ()=>{ save(); toast('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ') });
$('resetBtn').addEventListener('click', ()=>{ if (confirm('–°–±—Ä–æ—Å–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å?')){ localStorage.removeItem(STORAGE); location.reload(); } });
$('exportBtn').addEventListener('click', ()=>{
  const data = JSON.stringify(state, null, 2);
  const blob = new Blob([data], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download='shishka_generator_save.json'; a.click();
  URL.revokeObjectURL(url);
});

/* ===== Apply passive upgrade effects ===== */
function applyUpgradeEffects(cat){
  // simple immediate effects handled through state usage in other functions
  // but we can award coins or adjust values if needed
  if (cat==='generator'){
    // small immediate energy boost
    state.energy = Math.min(100, state.energy + 8 + state.upgrades.generator*2);
  }
  if (cat==='wiring'){
    // wiring reduces energy decay -> reflected in produceEnergyFromFuel
  }
  if (cat==='logistics'){
    // logistics improves collection speeds; implemented in chop/mine logic
  }
  if (cat==='fuel'){
    // increases fuel output in refining/burning; handled in formulas
  }
  if (cat==='misc'){
    // misc can increase find chance; handled
  }
  updateUI();
}

/* ===== Toasts & Modal ===== */
let toastTimer = null;
function toast(msg, t=1400){
  // small on-screen toast using modal area
  const el = document.createElement('div');
  el.style.position='fixed'; el.style.left='50%'; el.style.bottom='14px';
  el.style.transform='translateX(-50%)'; el.style.background='#06111a'; el.style.padding='10px 14px'; el.style.borderRadius='10px';
  el.style.border='1px solid rgba(255,255,255,0.03)'; el.style.zIndex=9999; el.style.boxShadow='0 8px 30px rgba(0,0,0,0.6)';
  el.textContent = msg;
  document.body.appendChild(el);
  setTimeout(()=> el.remove(), t);
}

function showModal(html){
  $('modalContent').innerHTML = html;
  $('modal').style.display = 'flex';
}
$('modalClose').addEventListener('click', ()=> $('modal').style.display='none');

/* ===== Update UI ===== */
function updateUI(){
  $('coins').textContent = format(state.coins);
  $('fuel').textContent = format(state.resources.fuelGas + state.resources.trash*0.2);
  $('load').textContent = format(state.load);
  $('powerDisplay').textContent = `–≠–Ω–µ—Ä–≥–∏—è: ${format(state.energy)}%`;
  $('levelDisplay').textContent = state.level;
  // generator visual tint
  const gv = $('genVisual');
  if (state.energy>66) gv.textContent='üîÜ'; else if (state.energy>33) gv.textContent='üîå'; else gv.textContent='‚ö°';
  // resource counts
  const tc = $('trashCount'); if (tc) tc.textContent = state.resources.trash;
  const wc = $('woodCount'); if (wc) wc.textContent = state.resources.wood;
  const cc = $('coalCount'); if (cc) cc.textContent = state.resources.coal;
  const oc = $('oilCount'); if (oc) oc.textContent = state.resources.oil;
  const fc = $('fuelCount'); if (fc) fc.textContent = state.resources.fuelGas;
  // shop initial render
  renderShop('generator');
}

/* ===== Initial render and autosaving ===== */
renderResources();
updateUI();
save();

// autosave every 10s
setInterval(()=> save(), 10000);

/* ===== Unlocking logic for levels based on energy thresholds ===== */
// Level 1 -> 2 at energy >=100
// Additional UI hint changes on level change handled in produceEnergyFromFuel()

</script>
</body>
</html>
